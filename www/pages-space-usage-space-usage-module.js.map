{"version":3,"sources":["./src/core/features/settings/pages/space-usage/space-usage.html","./src/core/features/settings/pages/space-usage/space-usage.module.ts","./src/core/features/settings/pages/space-usage/space-usage.ts"],"names":[],"mappings":"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","file":"pages-space-usage-space-usage-module.js","sourcesContent":["export default \"<ion-header>\\n    <ion-toolbar>\\n        <ion-buttons slot=\\\"start\\\">\\n            <ion-back-button [text]=\\\"'core.back' | translate\\\"></ion-back-button>\\n        </ion-buttons>\\n        <h1>{{ 'core.settings.spaceusage' | translate }}</h1>\\n        <ion-buttons slot=\\\"end\\\">\\n            <core-navbar-buttons>\\n                <ion-button (click)=\\\"showInfo()\\\" [attr.aria-label]=\\\"'core.info' | translate\\\">\\n                    <ion-icon name=\\\"fas-info-circle\\\" slot=\\\"icon-only\\\" aria-hidden=\\\"true\\\"></ion-icon>\\n                </ion-button>\\n            </core-navbar-buttons>\\n        </ion-buttons>\\n    </ion-toolbar>\\n</ion-header>\\n<ion-content>\\n    <ion-refresher [disabled]=\\\"!loaded\\\" (ionRefresh)=\\\"refreshData($event.target)\\\" slot=\\\"fixed\\\">\\n        <ion-refresher-content pullingText=\\\"{{ 'core.pulltorefresh' | translate }}\\\"></ion-refresher-content>\\n    </ion-refresher>\\n    <core-loading [hideUntil]=\\\"loaded\\\">\\n        <ion-item *ngFor=\\\"let site of sites\\\" [attr.aria-current]=\\\"site.id == currentSiteId ? 'page' : 'false'\\\">\\n            <ion-label class=\\\"ion-text-wrap\\\">\\n                <p class=\\\"item-heading\\\">\\n                    <core-format-text [text]=\\\"site.siteName\\\" clean=\\\"true\\\" [siteId]=\\\"site.id\\\"></core-format-text>\\n                </p>\\n                <p class=\\\"ion-text-wrap\\\">{{ site.fullName }}</p>\\n                <p>{{ site.siteUrl }}</p>\\n            </ion-label>\\n            <p *ngIf=\\\"site.spaceUsage !== undefined\\\" slot=\\\"end\\\">\\n                {{ site.spaceUsage | coreBytesToSize }}\\n            </p>\\n            <ion-button fill=\\\"clear\\\" color=\\\"danger\\\" slot=\\\"end\\\" (click)=\\\"deleteSiteStorage(site)\\\"\\n                [hidden]=\\\"site.spaceUsage! + site.cacheEntries! <= 0\\\"\\n                [attr.aria-label]=\\\"'core.settings.deletesitefilestitle' | translate\\\">\\n                <ion-icon name=\\\"fas-trash\\\" slot=\\\"icon-only\\\" aria-hidden=\\\"true\\\"></ion-icon>\\n            </ion-button>\\n        </ion-item>\\n        <ion-item-divider>\\n            <ion-label>\\n                <h2>{{ 'core.settings.total' | translate }}</h2>\\n            </ion-label>\\n            <p slot=\\\"end\\\" class=\\\"ion-margin-end\\\">\\n                {{ totals.spaceUsage | coreBytesToSize }}\\n            </p>\\n        </ion-item-divider>\\n    </core-loading>\\n</ion-content>\\n\";","// (C) Copyright 2015 Moodle Pty Ltd.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { NgModule } from '@angular/core';\nimport { RouterModule, Routes } from '@angular/router';\n\nimport { CoreSharedModule } from '@/core/shared.module';\nimport { CoreSettingsSpaceUsagePage } from './space-usage';\n\nconst routes: Routes = [\n    {\n        path: '',\n        component: CoreSettingsSpaceUsagePage,\n    },\n];\n\n@NgModule({\n    imports: [\n        RouterModule.forChild(routes),\n        CoreSharedModule,\n    ],\n    declarations: [\n        CoreSettingsSpaceUsagePage,\n    ],\n    exports: [RouterModule],\n})\nexport class CoreSettingsSpaceUsagePageModule {}\n","// (C) Copyright 2015 Moodle Pty Ltd.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Component, OnDestroy, OnInit } from '@angular/core';\nimport { IonRefresher } from '@ionic/angular';\n\nimport { CoreSiteBasicInfo, CoreSites } from '@services/sites';\nimport { CoreDomUtils } from '@services/utils/dom';\nimport { Translate } from '@singletons';\nimport { CoreEventObserver, CoreEvents } from '@singletons/events';\n\nimport { CoreSettingsHelper, CoreSiteSpaceUsage } from '../../services/settings-helper';\n\n/**\n * Page that displays the space usage settings.\n */\n@Component({\n    selector: 'page-core-app-settings-space-usage',\n    templateUrl: 'space-usage.html',\n})\nexport class CoreSettingsSpaceUsagePage implements OnInit, OnDestroy {\n\n    loaded = false;\n    sites: CoreSiteBasicInfoWithUsage[] = [];\n    currentSiteId = '';\n    totals: CoreSiteSpaceUsage = {\n        cacheEntries: 0,\n        spaceUsage: 0,\n    };\n\n    protected sitesObserver: CoreEventObserver;\n\n    constructor() {\n        this.currentSiteId = CoreSites.getCurrentSiteId();\n\n        this.sitesObserver = CoreEvents.on(CoreEvents.SITE_UPDATED, async (data) => {\n            const site = await CoreSites.getSite(data.siteId);\n\n            const siteEntry = this.sites.find((siteEntry) => siteEntry.id == site.id);\n            if (siteEntry) {\n                const siteInfo = site.getInfo();\n\n                siteEntry.siteName = site.getSiteName();\n\n                if (siteInfo) {\n                    siteEntry.siteUrl = siteInfo.siteurl;\n                    siteEntry.fullName = siteInfo.fullname;\n                }\n            }\n        });\n    }\n\n    /**\n     * View loaded.\n     */\n    ngOnInit(): void {\n        this.loadSiteData().finally(() => {\n            this.loaded = true;\n        });\n    }\n\n    /**\n     * Convenience function to load site data/usage and calculate the totals.\n     *\n     * @return Resolved when done.\n     */\n    protected async loadSiteData(): Promise<void> {\n        // Calculate total usage.\n        let totalSize = 0;\n        let totalEntries = 0;\n\n        this.sites = await CoreSites.getSortedSites();\n\n        const settingsHelper = CoreSettingsHelper.instance;\n\n        // Get space usage.\n        await Promise.all(this.sites.map(async (site) => {\n            const siteInfo = await settingsHelper.getSiteSpaceUsage(site.id);\n\n            site.cacheEntries = siteInfo.cacheEntries;\n            site.spaceUsage = siteInfo.spaceUsage;\n\n            totalSize += site.spaceUsage || 0;\n            totalEntries += site.cacheEntries || 0;\n        }));\n\n        this.totals.spaceUsage = totalSize;\n        this.totals.cacheEntries = totalEntries;\n    }\n\n    /**\n     * Refresh the data.\n     *\n     * @param event Refresher event.\n     */\n    refreshData(refresher?: IonRefresher): void {\n        this.loadSiteData().finally(() => {\n            refresher?.complete();\n        });\n    }\n\n    /**\n     * Deletes files of a site and the tables that can be cleared.\n     *\n     * @param siteData Site object with space usage.\n     */\n    async deleteSiteStorage(siteData: CoreSiteBasicInfoWithUsage): Promise<void> {\n        try {\n            const newInfo = await CoreSettingsHelper.deleteSiteStorage(siteData.siteName || '', siteData.id);\n\n            this.totals.spaceUsage -= siteData.spaceUsage! - newInfo.spaceUsage;\n            this.totals.spaceUsage -= siteData.cacheEntries! - newInfo.cacheEntries;\n\n            siteData.spaceUsage = newInfo.spaceUsage;\n            siteData.cacheEntries = newInfo.cacheEntries;\n        } catch {\n            // Ignore cancelled confirmation modal.\n        }\n    }\n\n    /**\n     * Show information about space usage actions.\n     */\n    showInfo(): void {\n        CoreDomUtils.showAlert(\n            Translate.instant('core.help'),\n            Translate.instant('core.settings.spaceusagehelp'),\n        );\n    }\n\n    /**\n     * Page destroyed.\n     */\n    ngOnDestroy(): void {\n        this.sitesObserver?.off();\n    }\n\n}\n\n/**\n * Basic site info with space usage and cache entries that can be erased.\n */\nexport interface CoreSiteBasicInfoWithUsage extends CoreSiteBasicInfo {\n    cacheEntries?: number; // Number of cached entries that can be cleared.\n    spaceUsage?: number; // Space used in this site.\n}\n"],"sourceRoot":"webpack:///"}